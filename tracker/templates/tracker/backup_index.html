{% extends 'tracker/base.html' %}
{% comment %} {% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shadcn/ui@latest/dist/shadcn.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'tracker/style.css' %}">

    
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                    <path d="M8 14l2 2 4-4"></path>
                </svg>
                <span class="fw-bold">Task Tracker</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            Projects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            Settings
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center ms-3">
                    <div class="position-relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white me-3">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            2
                        </span>
                    </div>
                    <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">
                        JS
                    </div>
                </div>
            </div>
        </div>
    </nav> {% endcomment %}

{% block title %}Dashboard{% endblock %}

{% block content %}


    <header class="flex items-center justify-between p-4 bg-white border-b">
        <div class="text-xl font-bold">Dashboard</div>
        <div class="flex items-center gap-4">
            <div class="relative">
                <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                ðŸ”” Notifications
            </div>
    
            {% if user.is_authenticated %}
                <!-- If user is logged in, show username and logout button -->
                <div class="bg-blue-500 flex items-center justify-center text-white font-bold w-20">
                    {{ user.username }}
                </div>
                {% comment %} <a href="{% url 'logout' %}" class="px-4 py-2 bg-red-500 text-white rounded">Logout</a> {% endcomment %}
                <form action="{% url 'logout' %}" method="post" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded">Logout</button>
                </form>
            {% else %}
                <!-- If user is not logged in, show Register and Sign In buttons -->
                <a href="{% url 'signup' %}" class="px-4 py-2 bg-green-500 text-white rounded">Register</a>
                <a href="{% url 'login' %}" class="px-4 py-2 bg-blue-500 text-white rounded">Sign In</a>
            {% endif %}
        </div>
    </header>
    {% if user.is_authenticated %}     
        <div class="app-container">    
            <aside class="w-64 bg-gray-900 text-gray-100 min-h-screen p-4 space-y-6">
                <div class="flex items-center gap-2">
                    <div class="text-xl font-bold">Task Tracker</div>
                </div>
                <nav class="flex flex-col space-y-2">
                    <a href="#dashboard" class="p-2 hover:bg-gray-800 rounded">Dashboard</a>
                    <a href="#tasks" class="p-2 hover:bg-gray-800 rounded">Ongoing Tasks</a>
                    <a href="#work-summary-card" class="p-2 hover:bg-gray-800 rounded">Reports</a>
                    <a href="#calender" class="p-2 hover:bg-gray-800 rounded">Tasks by Date</a>
                </nav>
                <div class="mt-auto">
                    <div class="text-sm">Welcome: </div>
                    <div class="font-bold"> {{ user.username }}!</div>
                </div>
            </aside>
            <main class="flex-1 p-6 space-y-6 bg-gray-50">
                <div class="card p-4" id="dashboard">
                    <h2 class="text-center font-bold text-4xl text-gray-800 p-3 mb-4 d-flex align-items-center justify-content-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                        Task Tracker
                    </h2>
                    <form method="POST" action="{% url 'start_task' %}">
                        {% csrf_token %}
                        <div class="input-group mb-3">
                            <input type="text" name="task_name" class="form-control" placeholder="What are you working on?" required>
                            <button type="submit" class="btn btn-success">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polygon points="10 8 16 12 10 16 10 8"></polygon>
                                </svg>
                                Start
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card" id="tasks">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="m-0 text-center font-bold text-2xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                                <path d="M12 6v6l4 2"></path>
                            </svg>
                            Ongoing Tasks
                        </h4>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% for task in tasks %}
                                <li class="list-group-item d-flex justify-content-between align-items-center task-item p-3 font-bold text-xl  alert-info">
                                    <div>
                                        <h5 class="mb-1">{{ task.task_name }}</h5>
                                        <small class="text-muted">Started at: {{ task.start_time }}</small>
                                    </div>
                                    <form method="POST" action="{% url 'end_task' task.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <rect x="9" y="9" width="6" height="6"></rect>
                                            </svg>
                                            Stop
                                        </button>
                                    </form>
                                </li>
                            {% empty %}
                                <div class="alert alert-info m-3 font-bold text-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="16" x2="12" y2="12"></line>
                                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                    </svg>
                                    No ongoing tasks. Start one above!
                                </div>
                            {% endfor %}
                        </ul>   
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-lg font-bold">Worked Hours</div>
                        <div class="text-3xl">{{ worked_hours }}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-lg font-bold">Tasks Today</div>
                        <div class="text-3xl">{{ tasks_count }}</div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow" id="work-summary-card">
                    <h2 class="font-bold text-xl mb-4">Work Summary (Last 5 Days)</h2>
                    <canvas id="workChart"></canvas>
                    <div class="button-container">
                        <button id="toggle-unit" class="btn btn-primary">Switch to Hours</button>
                    </div>
                   
                </div>
                <div class="bg-white p-6 rounded-lg shadow" id="calender">
                    <h2 class="font-bold text-xl mb-4">Completed Tasks (Pick Date)</h2>
                    <input type="date" id="task-date-picker" class="p-2 border rounded w-full">
                    <ul id="completed-tasks" class="mt-4 space-y-2">
                        <li class="p-2 bg-gray-100 rounded">Loading...</li>
                    </ul>
                </div>
            </main>
        </div>
        {% else %}
        <p>You are not logged in</p>
        <a href="{% url 'login' %}">Log In</a>
    {% endif %}

    <script>
        var labels = {{ labels|safe }};
        var durationsInMinutes = {{ durations|safe }};
        var workData = JSON.parse('{{ work_data|safe }}');
        var currentUnit = "minutes";
        var chartData = durationsInMinutes.slice();
        var ctx = document.getElementById('workChart').getContext('2d');
        var workChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Worked (Minutes)',
                    data: chartData,
                    backgroundColor: '#818cf8',
                    borderColor: '#4f46e5',
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        var index = elements[0].index; // Get clicked bar index
                        var selectedDate = labels[index]; // Get corresponding date
                        
                        // Get completed tasks for that date
                        var completedTasks = workData[selectedDate] || [];

                        // Populate sidebar with tasks
                        document.getElementById("completed-tasks").innerHTML = 
                            completedTasks.length 
                            ? completedTasks.map(task => `<li class='list-group-item task-item'>${task}</li>`).join('')
                            : '<li class="list-group-item">No completed tasks</li>';

                        // Show sidebar
                        document.getElementById("sidebar").classList.add("active");
                    }
                }
            }
        });
        
        
        // Toggle between minutes and hours
        document.getElementById("toggle-unit").addEventListener("click", function() {
            if (currentUnit === "minutes") {
                // Convert to hours - make sure we're working with numbers
                chartData = durationsInMinutes.map(mins => parseFloat((parseFloat(mins) / 60).toFixed(2))); 
                workChart.data.datasets[0].label = "Total Worked (Hours)";
                this.textContent = "Switch to Minutes";
                currentUnit = "hours";
            } else {
                // Convert back to minutes - ensure we're using the original data
                chartData = durationsInMinutes.map(min => parseFloat(min)); 
                workChart.data.datasets[0].label = "Total Worked (Minutes)";
                this.textContent = "Switch to Hours";
                currentUnit = "minutes";
            }

            // Update the chart data and force a redraw
            workChart.data.datasets[0].data = chartData;
            workChart.update();
        });




    </script>
    <script>
        document.getElementById("task-date-picker").addEventListener("change", function () {
            let selectedDate = this.value;
            
            fetch(`/tasks-by-date/?date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    let taskList = document.getElementById("completed-tasks");
                    taskList.innerHTML = "";  // Clear previous tasks
                    
                    if (data.tasks.length === 0) {
                        taskList.innerHTML = "<li class='list-group-item'>No tasks found</li>";
                    } else {
                        data.tasks.forEach(task => {
                            let listItem = document.createElement("li");
                            listItem.className = "list-group-item";
                            listItem.textContent = `${task.task_name} - ${task.duration}`;
                            taskList.appendChild(listItem);
                        });
                    }
                })
                .catch(error => console.error("Error fetching tasks:", error));
        });
    </script>

{% endblock %}

</body>
</html>